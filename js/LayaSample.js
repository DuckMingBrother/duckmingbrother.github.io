var CollisionCategory,Sprite=Laya.Sprite,Browser=Laya.Browser,worldWidth=1080,worldHeight=1980,brickSize=140,half_size=brickSize/2,w_num=7,h_num=14,offset=(worldWidth-brickSize*w_num)/(w_num+1),g_color="#FFFFFF",g_lineColor="#000000",g_border=1,ball_size=25,cannon_position={x:worldWidth/2,y:worldHeight-offset-ball_size},ball_speed=30,brickSpeed=brickSize/5,trianglePoints=[[0,0],[0,brickSize],[brickSize,0],[brickSize,brickSize]],pentagon=[{x:half_size*Math.cos(.1*Math.PI),y:-half_size*Math.sin(.1*Math.PI)},{x:0,y:-half_size},{x:-half_size*Math.cos(.1*Math.PI),y:-half_size*Math.sin(.1*Math.PI)},{x:-half_size*Math.sin(.2*Math.PI),y:half_size*Math.cos(.2*Math.PI)},{x:half_size*Math.sin(.2*Math.PI),y:half_size*Math.cos(.2*Math.PI)}];!function(e){e[e.none=0]="none",e[e.top=1]="top",e[e.right=2]="right",e[e.bottom=4]="bottom",e[e.left=8]="left",e[e.wall=15]="wall",e[e.brick=16]="brick",e[e.ball=32]="ball"}(CollisionCategory||(CollisionCategory={}));var Label;!function(e){e.top="top",e.right="right",e.bottom="bottom",e.left="left",e.ball="ball",e.brick="brick"}(Label||(Label={}));var GameMain=function(){function e(){this.Matter=Browser.window.Matter,this.LayaRender=Browser.window.LayaRender,this.bricks={},this.rowIndex=0,this.currentY=0,Laya.init(worldWidth,worldHeight),Laya.stage.alignV=Laya.Stage.ALIGN_MIDDLE,Laya.stage.alignH=Laya.Stage.ALIGN_CENTER,Laya.stage.scaleMode="showall",Laya.stage.bgColor="#edeced",this.initMatter(),this.initWorld()}return e.prototype.initMatter=function(){var e=new Sprite;Laya.stage.addChild(e),this.engine=this.Matter.Engine.create({enableSleeping:!0}),this.engine.world.gravity.x=0,this.engine.world.gravity.y=.01,this.Matter.Engine.run(this.engine);var t=this.LayaRender.create({engine:this.engine,container:e,width:worldWidth,height:worldHeight,options:{wireframes:!1,showAngleIndicator:!1}});this.LayaRender.run(t)},e.prototype.initWorld=function(){var e=this,t=[this.createWall(worldWidth/2,(offset-half_size)/2,worldWidth,half_size+offset,CollisionCategory.top,Label.top),this.createWall((offset-half_size)/2,worldHeight/2,half_size+offset,worldHeight,CollisionCategory.left,Label.left),this.createWall(worldWidth+(half_size-offset)/2,worldHeight/2,half_size+offset,worldHeight,CollisionCategory.right,Label.right),this.createWall(worldWidth/2,worldHeight+(half_size-offset)/2,worldWidth,half_size+offset,CollisionCategory.bottom,Label.bottom)];this.Matter.World.add(this.engine.world,t),Laya.timer.loop(1e3/brickSpeed,this,this.moveBrick),Laya.stage.on(Laya.Event.MOUSE_DOWN,this,function(t){var i=Matter.Bodies.circle(cannon_position.x,cannon_position.y,ball_size,{collisionFilter:{category:CollisionCategory.ball,mask:CollisionCategory.wall|CollisionCategory.brick},label:Label.ball,restitution:1,friction:0,frictionAir:0,inertia:Number.POSITIVE_INFINITY,render:{visible:!0,fillStyle:"#ffffff",strokeStyle:"#000000",lineWidth:1}}),r=Matter.Vector.sub(Matter.Vector.create(t.stageX,t.stageY),Matter.Vector.create(cannon_position.x,cannon_position.y)),o=Matter.Vector.mult(Matter.Vector.normalise(r),ball_speed);Matter.Body.setVelocity(i,o),e.Matter.World.add(e.engine.world,i)}),Matter.Events.on(this.engine,"collisionStart",function(t){for(var i=0,r=t.pairs;i<r.length;i++){var o=r[i],a=void 0,l=void 0;if(o.bodyA.label===Label.ball?(l=o.bodyA,a=o.bodyB):o.bodyB.label===Label.ball&&(l=o.bodyB,a=o.bodyA),a)switch(a.label){case Label.brick:var n=a.layaSprite,s=n.getChildAt(0);"1"===s.text?(Laya.stage.removeChild(a.layaSprite),a.collisionFilter.category=CollisionCategory.none,Matter.Sleeping.set(a,!0),e.bricks[n.rowIndex][n.columnIndex]=null,e.bricks[n.rowIndex].every(function(e){return!e})&&delete e.bricks[n.rowIndex]):s.text=+s.text-1+"";break;case Label.bottom:l&&(o.isActive=!1,l.position.y=worldHeight-ball_size,Matter.Sleeping.set(l,!0),l.collisionFilter.mask&=~CollisionCategory.bottom,Laya.Tween.to(l.position,{x:worldWidth/2},100,null,Laya.Handler.create(e,function(){})))}}}),this.lv=new Laya.Text,this.lv.fontSize=100,this.lv.color="#000000",this.lv.pos(20,worldHeight-110),Laya.stage.addChild(this.lv)},e.prototype.createWall=function(e,t,i,r,o,a){var l={collisionFilter:{category:o,mask:CollisionCategory.ball},label:a,isStatic:!0,render:{fillStyle:"#123456"}};return this.Matter.Bodies.rectangle(e,t,i,r,l)},e.prototype.createRow=function(e){for(var t=[],i=0,r=offset;r<worldWidth;r+=brickSize){var o=void 0;if(Math.random()>.5){var a=this.getRandomColor();(o=new Sprite).pos(r,e),this.createBrick(o,a,Math.ceil(50*Math.random())+1),Laya.stage.addChild(o),o.rowIndex=this.rowIndex,o.columnIndex=i}t.push(o),i++,r+=offset}this.bricks[this.rowIndex]=t,this.rowIndex++},e.prototype.createBrick=function(e,t,i){var r,o,a=Math.random(),l=e.x+half_size,n=e.y+half_size,s={collisionFilter:{category:CollisionCategory.brick,mask:CollisionCategory.ball},label:Label.brick,layaSprite:e,isStatic:!0,render:{fillStyle:t,strokeStyle:g_lineColor,lineWidth:g_border,visible:!1,sprite:{xOffset:-half_size,yOffset:-half_size}}};if(a<.7)r=this.Matter.Bodies.rectangle(l,n,brickSize,brickSize,s),e.graphics.drawRect(0,0,brickSize,brickSize,t,g_lineColor,g_border);else if(a<.8){var h=Math.floor(Math.random()*trianglePoints.length);(b=trianglePoints.slice()).splice(h,1);var c=Matter.Vertices.centre(b.map(function(e){return{x:e[0]-half_size,y:e[1]-half_size}}));r=this.Matter.Bodies.fromVertices(l+c.x,n+c.y,b.map(function(e){return Matter.Vector.create(e[0]-half_size,e[1]-half_size)}),s,!0),e.graphics.drawPoly(0,0,b[0].concat(b[1],b[2]),t,g_lineColor,g_border);var d=trianglePoints[h],f=d[0],g=d[1];o=[f?0:brickSize,g?0:brickSize]}else if(a<.9)r=this.Matter.Bodies.circle(l,n,half_size,s),e.graphics.drawCircle(half_size,half_size,half_size,t,g_lineColor,g_border);else{for(var b=[],y=0,w=pentagon;y<w.length;y++){var p=w[y];b.push(p.x,p.y)}r=this.Matter.Bodies.fromVertices(l,n,pentagon.map(function(e){return Matter.Vector.create(e.x,e.y)}),s),e.graphics.drawPoly(half_size,half_size,b,t,g_lineColor,g_border)}var _=new Laya.Text;if(_.align="center",_.fontSize=50,_.color="#ffffff",_.stroke=5,_.text=i+"",o){var z=o[0],M=o[1];z&&(z-=_.width),M&&(M-=_.height),_.pos(z,M)}else _.pos((brickSize-_.width)/2,(brickSize-_.height)/2);return this.Matter.World.add(this.engine.world,[r]),e.addChild(_),e.body=r,e},e.prototype.getRandomColor=function(){return"#"+Math.floor(16777215*Math.random()).toString(16)},e.prototype.moveBrick=function(){for(var e=0,t=Object.keys(this.bricks);e<t.length;e++){var i=t[e],r=this.bricks[i].find(function(e){return!!e});if(r){if((l=r.body).position.y+brickSize>worldHeight)return void this.loseGame()}else delete this.bricks[i];break}0===this.currentY&&(this.createRow(-brickSize),this.lv.text="lv:"+this.rowIndex),this.currentY++,this.currentY>brickSize+offset&&(this.currentY=0);for(var o=0,a=this.engine.world.bodies;o<a.length;o++){var l=a[o];l.label===Label.brick&&(Matter.Body.setPosition(l,{x:l.position.x,y:l.position.y+1}),l.layaSprite.y+=1)}},e.prototype.loseGame=function(){Laya.timer.clear(this,this.moveBrick),alert("You 魯蛇")},e}();new GameMain;