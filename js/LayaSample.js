var CollisionCategory,Sprite=Laya.Sprite,Browser=Laya.Browser,worldWidth=1080,worldHeight=1980,brickSize=140,half_size=brickSize/2,w_num=7,h_num=14,offset=(worldWidth-brickSize*w_num)/(w_num+1),g_color="#FFFFFF",g_lineColor="#000000",g_border=1,ball_size=25,cannon_position={x:worldWidth/2,y:worldHeight-offset-ball_size},ball_speed=30,trianglePoints=[[0,0],[0,brickSize],[brickSize,0],[brickSize,brickSize]],pentagon=[{x:half_size*Math.cos(.1*Math.PI),y:-half_size*Math.sin(.1*Math.PI)},{x:0,y:-half_size},{x:-half_size*Math.cos(.1*Math.PI),y:-half_size*Math.sin(.1*Math.PI)},{x:-half_size*Math.sin(.2*Math.PI),y:half_size*Math.cos(.2*Math.PI)},{x:half_size*Math.sin(.2*Math.PI),y:half_size*Math.cos(.2*Math.PI)}];!function(e){e[e.none=0]="none",e[e.wall=1]="wall",e[e.brick=2]="brick",e[e.ball=4]="ball",e[e.cannon=8]="cannon"}(CollisionCategory||(CollisionCategory={}));var Label;!function(e){e.top="top",e.right="right",e.bottom="bottom",e.left="left",e.ball="ball",e.brick="brick",e.cannon="cannon"}(Label||(Label={}));var GameMain=function(){function e(){this.Matter=Browser.window.Matter,this.LayaRender=Browser.window.LayaRender,Laya.init(worldWidth,worldHeight),Laya.stage.alignV=Laya.Stage.ALIGN_MIDDLE,Laya.stage.alignH=Laya.Stage.ALIGN_CENTER,Laya.stage.scaleMode="showall",Laya.stage.bgColor="#edeced",this.initMatter(),this.initWorld()}return e.prototype.initMatter=function(){var e=new Sprite;Laya.stage.addChild(e),this.engine=this.Matter.Engine.create({enableSleeping:!0}),this.engine.world.gravity.x=0,this.engine.world.gravity.y=0,this.Matter.Engine.run(this.engine);var t=this.LayaRender.create({engine:this.engine,container:e,width:worldWidth,height:worldHeight,options:{wireframes:!1}});this.LayaRender.run(t)},e.prototype.initWorld=function(){var e=this,t={collisionFilter:{category:CollisionCategory.wall},isStatic:!0,render:{fillStyle:"#123456"}},i=[this.Matter.Bodies.rectangle(worldWidth/2,(offset-half_size)/2,worldWidth,half_size+offset,t),this.Matter.Bodies.rectangle((offset-half_size)/2,worldHeight/2,half_size+offset,worldHeight,t),this.Matter.Bodies.rectangle(worldWidth+(half_size-offset)/2,worldHeight/2,half_size+offset,worldHeight,t),this.Matter.Bodies.rectangle(worldWidth/2,worldHeight+(half_size-offset)/2,worldWidth,half_size+offset,t)];i[0].label=Label.top,i[1].label=Label.left,i[2].label=Label.right,i[3].label=Label.bottom,this.Matter.World.add(this.engine.world,i);this.createGraphics();var a=this.Matter.Bodies.circle(cannon_position.x,cannon_position.y,ball_size,{collisionFilter:{category:CollisionCategory.cannon,mask:CollisionCategory.ball|CollisionCategory.brick},isStatic:!0,render:{visible:!1}});this.Matter.World.add(this.engine.world,a),Laya.stage.on(Laya.Event.MOUSE_DOWN,this,function(t){var i=Matter.Bodies.circle(cannon_position.x,cannon_position.y,ball_size,{collisionFilter:{category:CollisionCategory.ball,mask:CollisionCategory.wall|CollisionCategory.brick},restitution:1,friction:0,frictionAir:0,inertia:Number.POSITIVE_INFINITY,render:{visible:!0,fillStyle:"#ffffff",strokeStyle:"#000000",lineWidth:1}}),a=Matter.Vector.sub(Matter.Vector.create(t.stageX,t.stageY),Matter.Vector.create(cannon_position.x,cannon_position.y)),r=Matter.Vector.mult(Matter.Vector.normalise(a),ball_speed);Matter.Body.setVelocity(i,r),e.Matter.World.add(e.engine.world,i)}),Matter.Events.on(this.engine,"collisionStart",function(e){for(var t=0,i=e.pairs;t<i.length;t++){var a=i[t],r=void 0;if(r=a.bodyA.label===Label.ball?a.bodyB:a.bodyA)switch(r.label){case Label.brick:var o=r.layaSprite.getChildAt(0);"1"===o.text?(Laya.stage.removeChild(r.layaSprite),r.collisionFilter.category=CollisionCategory.none,Matter.Sleeping.set(r,!0)):o.text=+o.text-1+"";break;case Label.bottom:r.inertia=0,Matter.Body.setVelocity(r,Matter.Vector.create(ball_speed*r.position.x>worldWidth/2?-1:1,0));break;case Label.cannon:r.collisionFilter.category=CollisionCategory.none,r.render.visible=!1,Matter.Sleeping.set(r,!0)}}})},e.prototype.createGraphics=function(){for(var e=[],t=worldHeight/2,i=offset;i<t;i+=brickSize)e.push(this.createRow(i)),i+=offset;return e},e.prototype.createRow=function(e){for(var t=[],i=offset;i<worldWidth;i+=brickSize){if(Math.random()>.3){var a=this.getRandomColor(),r=new Sprite;r.pos(i,e),this.createGraphic(r,a,Math.ceil(99*Math.random())+1),Laya.stage.addChild(r),t.push(r)}i+=offset}return t},e.prototype.createGraphic=function(e,t,i){var a,r,o=Math.random(),l=e.x+half_size,n=e.y+half_size,s={collisionFilter:{category:CollisionCategory.brick},layaSprite:e,isStatic:!0,render:{fillStyle:t,strokeStyle:g_lineColor,lineWidth:g_border,visible:!1,sprite:{xOffset:-half_size,yOffset:-half_size}}};if(o<.7)a=this.Matter.Bodies.rectangle(l,n,brickSize,brickSize,s),e.graphics.drawRect(0,0,brickSize,brickSize,t,g_lineColor,g_border);else if(o<.8){var h=Math.floor(Math.random()*trianglePoints.length);(b=trianglePoints.slice()).splice(h,1);var c=Matter.Vertices.centre(b.map(function(e){return{x:e[0]-half_size,y:e[1]-half_size}}));a=this.Matter.Bodies.fromVertices(l+c.x,n+c.y,b.map(function(e){return Matter.Vector.create(e[0]-half_size,e[1]-half_size)}),s,!0),e.graphics.drawPoly(0,0,b[0].concat(b[1],b[2]),t,g_lineColor,g_border);var d=trianglePoints[h],f=d[0],g=d[1];r=[f?0:brickSize,g?0:brickSize]}else if(o<.9)a=this.Matter.Bodies.circle(l,n,half_size,s),e.graphics.drawCircle(half_size,half_size,half_size,t,g_lineColor,g_border);else{for(var b=[],y=0,_=pentagon;y<_.length;y++){var M=_[y];b.push(M.x,M.y)}a=this.Matter.Bodies.fromVertices(l,n,pentagon.map(function(e){return Matter.Vector.create(e.x,e.y)}),s),e.graphics.drawPoly(half_size,half_size,b,t,g_lineColor,g_border),console.log(a)}var p=new Laya.Text;if(p.align="center",p.fontSize=50,p.color="#ffffff",p.stroke=5,p.text=i+"",r){var w=r[0],z=r[1];w&&(w-=p.width),z&&(z-=p.height),p.pos(w,z)}else p.pos((brickSize-p.width)/2,(brickSize-p.height)/2);return this.Matter.World.add(this.engine.world,[a]),e.addChild(p),a.label=Label.brick,e},e.prototype.getRandomColor=function(){return"#"+Math.floor(16777215*Math.random()).toString(16)},e}();new GameMain;